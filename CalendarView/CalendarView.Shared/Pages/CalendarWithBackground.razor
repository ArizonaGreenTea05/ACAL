@page "/calendar"
@using System.Globalization
@using System.Timers
@using CalendarView.Core.ViewModels
@using CalendarView.Services
@using CalendarView.Shared.Models
@using CalendarView.Shared.Resources
@using Common.UI.Extensions
@using Microsoft.AspNetCore.WebUtilities
@using Microsoft.Extensions.Logging
@using static CalendarView.Shared.Utils.CommonFunctions
@inject CalendarViewModel CalendarViewModel
@inject Design Design
@inject ILogger<CalendarWithBackground> Logger
@inject PictureService PictureService
@inject NavigationManager Navigation;

<PageTitle>Calendar</PageTitle>

<style>
	.background-image {
		background-image:
		@(Design.CustomBackgroundImageOverlay ?? "radial-gradient(circle at center, rgba(0, 0, 0, 0.7) 40%, rgba(0, 0, 0, 0.8) 100%)"), url('@CurrentPictureUrl');
		background-blend-mode: multiply;
		background-repeat: no-repeat;
		background-position: center;
		background-size: cover;
	}
</style>

<div class="grid-container @(ShowBackgroundImage ? "background-image" : "")" style="margin: 0px; padding: 0px; height: 100vh; width: 100%; grid-template-columns: 0fr 1fr">
	<div class="header" style="display: flex; flex-direction: row;">
		<div>
			@if (Design.ShowTime)
			{
				<div style="width: fit-content; margin: 0px auto 0px 10px; padding: 0px;">
					<a style="font-size: 80px">@_currentTimeString</a>
				</div>
			}
			@if (Design.ShowDate)
			{
				<div style="width: fit-content; margin: 0px auto 10px 10px; padding: 0px;">
					<a style="font-size: 19px">@_currentDateString</a>
				</div>
			}
		</div>
	</div>

	<div class="footer">
		<div>
			@if (Design.ShowColorLegend)
			{
				<div style="width: 100%; display: flex; flex-direction: row; margin: 2px;">
					@foreach (var calendar in GetCalendarsOrderedByColor(CalendarViewModel.Calendars, Design.EventCardDimmingRatio))
					{

						<div class="event-card" style="background-color: @calendar.dimBackColor.ToHex(); border-left-color: @calendar.backColor.ToHex(); color: @calendar.foreColor.ToHex(); margin: 3px; padding: 0px 5px; border-radius: 5px; border-left-width: 3px">
							@calendar.calendar.Name
						</div>
						Logger.LogDebug("Added calendar '{name} with color {backColor}", calendar.calendar.Name, calendar.backColor.ToHex());
					}
				</div>
			}
		</div>
	</div>

	<div class="content" style="grid-area: content;
				overflow-y: scroll;
				overflow-x: hidden;
				height: 100%;
				padding: 10px;
				margin: 0px;">
		<div class="flow-grid-container" style="grid-template-columns: auto auto auto auto;">
			@{
				InitCalendarParams(CalendarViewModel.Events, out var events, out var startDay, out var endDay, out var today, out var yesterday, out var tomorrow);
			}
			@for (var day = startDay; day <= endDay; day = day.AddDays(1))
			{
				InitCalendarParamsForDay(events, day, today, tomorrow, yesterday, CurrentCulture, Design.LongDayFormat, out var todaysEvents, out var allDayEvents, out var normalDayEvents, out var currentDayName);

				<div>
					<div>
						<a style="font-size: 40px; font-weight: 400;">@day.Day</a>
						<a style="font-size: 30px; padding-left: 10px;">@currentDayName</a>
					</div>

					@if (todaysEvents.Count <= 0)
					{
						<div>
							<a colspan="4">>@Translations.ResourceManager.GetString(nameof(Translations.NoEvents), CurrentCulture)</a>
						</div>
					}

					@if (allDayEvents.Count > 0)
					{
						<div style="margin: 5px;">
							@foreach (var ev in allDayEvents.OrderBy(ev => ev.Start))
							{
								var backColor = ev.Calendar.Color;
								var dimBackColor = backColor.GetDimColor(Design.EventCardDimmingRatio);
								var foreColor = dimBackColor.GetForeColor();
								var dimForeColor = foreColor.GetDimColor(0.9);

								<div class="event-card" style="background-color: @dimBackColor.ToHex(); border-left-color: @backColor.ToHex(); margin-bottom: 10px;">
									<div class="grid-container" style="grid-template-columns: 100px 100%; padding: 2px; margin: 5px; border-radius: 10px;">
										<div class="menu" style="text-align: left;">
											<a style="color: @dimForeColor.ToHex(); font-size: 19px; font-weight: 600;">@Translations.ResourceManager.GetString(nameof(Translations.AllDay), CurrentCulture)</a>
										</div>
										<div class="content" style="text-align: left;">
											<a style="text-align: left; color: @foreColor.ToHex(); font-size: 19px; font-weight: 600;">@ev.Name</a>
											<br>
											<a style="text-align: left; color: @dimForeColor.ToHex()">
												@ev.Start.ToShortDateString(Design.ShortDateFormat, CurrentCulture) @(ev.Start == ev.End ? "" : $"- {ev.End.ToShortDateString(Design.ShortDateFormat, CurrentCulture)}")
											</a>
										</div>
									</div>
								</div>

								Logger.LogDebug("Added all day event '{name}' of calendar '{calendar}' with color {backColor}", ev.Name, ev.Calendar.Name, backColor.ToHex());
							}
						</div>
					}

					@if (normalDayEvents.Count > 0)
					{
						<div style="margin: 5px;">
							@foreach (var ev in normalDayEvents.OrderBy(ev => ev.Start))
							{
								var backColor = ev.Calendar.Color;
								var dimBackColor = backColor.GetDimColor(Design.EventCardDimmingRatio);
								var foreColor = dimBackColor.GetForeColor();
								var dimForeColor = foreColor.GetDimColor(0.9);

								<div class="event-card" style="background-color: @dimBackColor.ToHex(); border-left-color: @backColor.ToHex(); margin-bottom: 10px;">
									<div class="grid-container" style="grid-template-columns: 100px 100%; padding: 2px; margin: 5px; border-radius: 10px;">
										<div class="menu" style="text-align: left;">
											<a style="color: @dimForeColor.ToHex(); font-size: 19px; font-weight: 600;">
												@ev.Start.ToShortTimeString(Design.ShortTimeFormat, CurrentCulture)
											</a>
											<br />
											<a style="color: @dimForeColor.ToHex();">
												@ev.End.ToShortTimeString(Design.ShortTimeFormat, CurrentCulture)
											</a>
										</div>
										<div class="content" style="text-align: left;">
											<a style="text-align: left; color: @foreColor.ToHex(); font-size: 19px; font-weight: 600;">@ev.Name</a>
											<br>
											<a style="text-align: left; color: @dimForeColor.ToHex();">
												@ev.Start.Date.ToShortDateString(Design.ShortDateFormat, CurrentCulture) @(ev.Start.Date == ev.End.Date ? "" : $"- {ev.End.Date.ToShortDateString(Design.ShortDateFormat, CurrentCulture)}")
											</a>
										</div>
									</div>
								</div>

								Logger.LogDebug("Added event '{name}' of calendar '{calendar}' with color {backColor}", ev.Name, ev.Calendar.Name, backColor.ToHex());
							}
						</div>
					}

				</div>
			}
		</div>
	</div>
</div>


@code {
	private Timer? _timeTimer;
	private string _currentTimeString = DateTime.Now.ToShortTimeString();
	private string _currentDateString = DateTime.Now.ToLongDateString();
	private CultureInfo CurrentCulture => new(Design.Language);

	[Parameter] public bool ShowBackgroundImage { get; set; } = false;

	private string CurrentPictureUrl => PictureService.CurrentPictureBase64 is null ? string.Empty : $"data:image/jpeg;base64,{PictureService.CurrentPictureBase64}";

	protected override async Task OnInitializedAsync()
	{
		Logger.LogInformation("Started initialization");

		var uri = Navigation.ToAbsoluteUri(Navigation.Uri);
		var queryParameters = QueryHelpers.ParseQuery(uri.Query);
		if (queryParameters.TryGetValue(key: "showBackgroundImage",
			    value: out var showBackgroundImage))
		{
			ShowBackgroundImage = bool.TryParse(showBackgroundImage, out var showImage) && showImage;
			Logger.LogInformation("ShowBackgroundImage={value}", ShowBackgroundImage);
		}

		if (_timeTimer is null)
		{
			_timeTimer = new Timer(TimeSpan.FromSeconds(10));
			_timeTimer.Elapsed += async (_, _) =>
			{
				var currentTimeString = DateTime.Now.ToShortTimeString(Design.ShortTimeFormat, CurrentCulture);
				if (currentTimeString == _currentTimeString) return;
				_currentTimeString = currentTimeString;
				_currentDateString = DateTime.Now.ToLongDateString(Design.LongDateFormat, CurrentCulture);
				await InvokeAsync(StateHasChanged);
				Logger.LogDebug("Time updated");
			};

			Logger.LogInformation("Initialized time timer");
		}

		PictureService.PictureHasChanged += async (_, _) =>
		{
			if (ShowBackgroundImage) await InvokeAsync(StateHasChanged);
		};
		CalendarViewModel.RefreshedCalendars += async (_, _) => await InvokeAsync(StateHasChanged);

		_timeTimer.Start();
		CalendarViewModel.StartRefreshTimer();
		await InvokeAsync(StateHasChanged);
		Logger.LogInformation("Finished initialization");
	}
}